<!-- templates/note_url.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Shared Note</title>
  <link rel="stylesheet" href="/static/style.css">
</head>
<body>
  <div class="container">
    <h1>Ghi Chú Chia Sẻ</h1>
    <!-- Đoạn này server sẽ render ciphertext -->
    <div id="ciphertext" data-ciphertext="{{ ciphertext|safe }}"></div>
    <p><strong>Note ID:</strong> {{ note_id }}</p>
    <p><strong>Owner:</strong> {{ owner }}</p>
    <hr>
    <p id="decrypted-content">Đang giải mã nội dung...</p>
  </div>

  <!-- Thư viện CryptoJS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/aes.min.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      // Lấy ciphertext từ data attribute
      const ctDiv = document.getElementById("ciphertext");
      const ciphertext = ctDiv.dataset.ciphertext;

      // Gọi /get-secret để lấy secretKey (demo)
      fetch("/get-secret", {
        method: "GET",
        headers: { "Content-Type": "application/json" }
      })
      .then(res => res.json())
      .then(data => {
        if (data.secretKey) {
          const secretKey = data.secretKey;
          // Giải mã
          const decrypted = CryptoJS.AES.decrypt(ciphertext, secretKey).toString(CryptoJS.enc.Utf8);
          const p = document.getElementById("decrypted-content");
          if (decrypted) {
            p.textContent = decrypted;
          } else {
            p.textContent = "Không thể giải mã ghi chú (hoặc ghi chú rỗng).";
          }
        } else {
          alert("Không thể lấy secretKey");
        }
      })
      .catch(err => {
        console.error("Error:", err);
        document.getElementById("decrypted-content").textContent = "Lỗi khi giải mã.";
      });
    });
  </script>
</body>
</html>
